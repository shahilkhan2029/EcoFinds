{% extends "services/base.html" %}

{% block service_title %}Home Loan Calculator{% endblock %}

{% block service_content %}
<form id="loanForm" class="needs-validation" novalidate>
    <div class="mb-3">
        <label for="property_value" class="form-label">Property Value ($)</label>
        <input type="number" class="form-control" id="property_value" name="property_value" required min="10000">
        <div class="invalid-feedback">Please enter a valid property value.</div>
    </div>
    
    <div class="mb-3">
        <label for="down_payment" class="form-label">Down Payment ($)</label>
        <input type="number" class="form-control" id="down_payment" name="down_payment" required min="0">
        <div class="invalid-feedback">Please enter a valid down payment.</div>
    </div>
    
    <div class="mb-3">
        <label for="interest_rate" class="form-label">Interest Rate (%)</label>
        <input type="number" class="form-control" id="interest_rate" name="interest_rate" required min="0" step="0.01">
        <div class="invalid-feedback">Please enter a valid interest rate.</div>
    </div>
    
    <div class="mb-3">
        <label for="loan_term" class="form-label">Loan Term (years)</label>
        <select class="form-select" id="loan_term" name="loan_term" required>
            <option value="">Select loan term</option>
            <option value="15">15 years</option>
            <option value="20">20 years</option>
            <option value="25">25 years</option>
            <option value="30">30 years</option>
        </select>
        <div class="invalid-feedback">Please select a loan term.</div>
    </div>
    
    <div class="text-center">
        <button type="submit" class="btn btn-primary">Calculate Loan</button>
    </div>
</form>

<div id="result" class="mt-4" style="display: none;">
    <div class="alert alert-info">
        <h4 class="alert-heading">Loan Details</h4>
        <p>Monthly Payment: <strong id="monthlyPayment"></strong></p>
        <p>Total Interest: <strong id="totalInterest"></strong></p>
        <p>Total Payment: <strong id="totalPayment"></strong></p>
    </div>
    
    <h5 class="mt-4">Amortization Schedule</h5>
    <div class="table-responsive">
        <table class="table table-striped" id="amortizationTable">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Payment</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block service_scripts %}
<script>
document.getElementById('loanForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!this.checkValidity()) {
        e.stopPropagation();
        this.classList.add('was-validated');
        return;
    }
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/services/home-loans', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                property_value: formData.get('property_value'),
                down_payment: formData.get('down_payment'),
                interest_rate: formData.get('interest_rate'),
                loan_term: formData.get('loan_term')
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            });
            
            document.getElementById('monthlyPayment').textContent = formatter.format(data.monthly_payment);
            document.getElementById('totalInterest').textContent = formatter.format(data.total_interest);
            document.getElementById('totalPayment').textContent = formatter.format(data.total_payment);
            
            const tbody = document.querySelector('#amortizationTable tbody');
            tbody.innerHTML = '';
            
            data.amortization_schedule.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.month}</td>
                    <td>${formatter.format(entry.payment)}</td>
                    <td>${formatter.format(entry.principal)}</td>
                    <td>${formatter.format(entry.interest)}</td>
                    <td>${formatter.format(entry.balance)}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('result').style.display = 'block';
        } else {
            alert(data.error || 'An error occurred while calculating the loan.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while calculating the loan.');
    }
});
</script>
{% endblock %} 